<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Collaborative Mapping System</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
}
#map {
    height: 100%;
    width: 100%;
    z-index: 0;
    position: absolute;
    border: 5px solid #1f2937; /* Visible map border */
    box-sizing: border-box;
}
.leaflet-popup-content-wrapper {
    border-radius: 1rem;
    box-shadow: 0 10px 15px rgba(0,0,0,0.2);
}
.leaflet-popup-content {
    color: #1f2937; /* Tailwind gray-800 */
}
#search-form {
    cursor: default;
}
</style>
</head>
<body class="font-sans antialiased">

<div class="relative h-screen w-screen">
    <div id="map"></div>

    <!-- My Location Button -->
<div class="absolute top-20 left-1/2 -translate-x-1/2 z-20">
    <button id="my-location-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
        My Location
    </button>
</div>


    <!-- Search Box -->
    <div class="absolute top-4 right-4 z-20">
        <form id="search-form" class="flex items-center bg-white rounded-full shadow-lg">
            <input id="search-input" type="text" placeholder="Search for a place..." class="py-2 px-4 rounded-l-full focus:outline-none w-48 sm:w-64 bg-transparent">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 p-3 rounded-r-full transition-colors">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </button>
        </form>
    </div>

    <!-- Editor Mode Button -->
    <div class="absolute top-4 left-1/2 -translate-x-1/2 z-20">
        <button id="editor-mode-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
            Enter Editor Mode
        </button>
        <div id="editor-status" class="bg-white/90 backdrop-blur-sm text-gray-800 font-semibold py-2 px-4 rounded-full shadow-lg mt-2 hidden text-center">
            Editor Mode Active
        </div>
    </div>

    <!-- Pin Modal -->
    <div id="pin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-md transform transition-all scale-95 opacity-0" id="pin-modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Add New Location</h2>
            <form id="pin-form">
                <div class="mb-4">
                    <label for="pin-name" class="block text-gray-700 text-sm font-bold mb-2">Location Name</label>
                    <input type="text" id="pin-name" required class="shadow-sm border rounded-lg w-full py-3 px-4 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label for="pin-desc" class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                    <textarea id="pin-desc" rows="3" required class="shadow-sm border rounded-lg w-full py-3 px-4 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="flex items-center justify-end gap-3">
                    <button type="button" id="cancel-pin-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Save Pin</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Password, Alert, Confirm Modals (same as before) -->
    <div id="password-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-sm transform transition-all scale-95 opacity-0" id="password-modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Enter Password</h2>
            <form id="password-form">
                <div class="mb-4">
                    <label for="password-input" class="block text-gray-700 text-sm font-bold mb-2">Editor Password</label>
                    <input type="password" id="password-input" required class="shadow-sm border rounded-lg w-full py-3 px-4 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center justify-end gap-3">
                    <button type="button" id="cancel-password-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <div id="alert-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-sm transform transition-all scale-95 opacity-0" id="alert-modal-content">
            <p id="alert-message" class="text-center text-gray-800 mb-6"></p>
            <div class="flex justify-center">
                <button id="ok-alert-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">OK</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-sm transform transition-all scale-95 opacity-0" id="confirm-modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Are you sure?</h3>
            <p id="confirm-message" class="text-gray-700 mb-6"></p>
            <div class="flex items-center justify-end gap-3">
                <button id="cancel-confirm-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Cancel</button>
                <button id="confirm-action-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK (non-module) -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js"></script>

<script>
const EDITOR_PASSWORD = "edit";
const firebaseConfig = {
    apiKey: "AIzaSyBeKqCApxnkuhP8XMGQNh_3s6a85QdTWBU",
    authDomain: "mapping-system-7e62f.firebaseapp.com",
    databaseURL: "https://mapping-system-7e62f-default-rtdb.firebaseio.com",
    projectId: "mapping-system-7e62f",
    storageBucket: "mapping-system-7e62f.appspot.com",
    messagingSenderId: "466910563569",
    appId: "1:466910563569:web:4736a59508f09630f92d50"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map, isEditorMode=false, currentLatLng=null, markersOnMap={}, confirmAction=null;

// --- Initialize Map ---
function initMap() {
    const southWest = L.latLng(-60, -120);
    const northEast = L.latLng(60, 120);
    const bounds = L.latLngBounds(southWest, northEast);

    map = L.map('map', { 
        maxBounds: bounds,
        maxBoundsViscosity: 1.0
    }).setView([20,0],2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom:19,
        attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);

    map.on('click', onMapClick);
}

// --- Marker Handling ---
function listenForMarkers() {
    const markersRef = firebase.database().ref('markers');
    markersRef.on('value', snapshot => {
        Object.values(markersOnMap).forEach(m => map.removeLayer(m));
        markersOnMap={};
        snapshot.forEach(child => {
            const data = child.val();
            if(data.lat && data.lng){
                const marker = L.marker([data.lat, data.lng]).addTo(map);
                let popup=`<div class="p-2"><h3 class="font-bold text-lg mb-1">${escapeHTML(data.name)}</h3><p>${escapeHTML(data.description)}</p>`;
                if(isEditorMode) popup += `<button data-id="${child.key}" class="delete-btn mt-3 bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-full">Delete</button>`;
                popup += '</div>';
                marker.bindPopup(popup);
                marker.on('click', e=>map.flyTo(e.latlng,15));
                markersOnMap[child.key]=marker;
            }
        });
    });
}

// --- Helper ---
function escapeHTML(str){ const p=document.createElement('p'); p.textContent=str; return p.innerHTML; }
function showModal(id){ const m=document.getElementById(id), c=document.getElementById(`${id}-content`); m.classList.remove('hidden'); setTimeout(()=>c.classList.remove('scale-95','opacity-0'),10);}
function hideModal(id){ const m=document.getElementById(id), c=document.getElementById(`${id}-content`); c.classList.add('scale-95','opacity-0'); setTimeout(()=>m.classList.add('hidden'),200);}
function showAlert(msg){ document.getElementById('alert-message').textContent=msg; showModal('alert-modal'); }
function showConfirm(msg){ document.getElementById('confirm-message').textContent=msg; showModal('confirm-modal'); }

// --- Event Handlers ---
function toggleEditorMode(){
    if(isEditorMode){ isEditorMode=false; updateUIAfterModeChange(); return; }
    document.getElementById('password-input').value='';
    showModal('password-modal');
}

function handlePasswordSubmit(e){
    e.preventDefault();
    const pw = document.getElementById('password-input').value;
    hideModal('password-modal');
    if(pw===EDITOR_PASSWORD){ isEditorMode=true; alert('Editor mode activated'); updateUIAfterModeChange(); }
    else if(pw) alert('Incorrect password');
}

function updateUIAfterModeChange(){
    const status=document.getElementById('editor-status');
    const btn=document.getElementById('editor-mode-btn');
    status.classList.toggle('hidden',!isEditorMode);
    if(isEditorMode){ btn.textContent='Exit Editor Mode'; btn.classList.replace('bg-blue-600','bg-red-600'); btn.classList.replace('hover:bg-blue-700','hover:bg-red-700'); }
    else { btn.textContent='Enter Editor Mode'; btn.classList.replace('bg-red-600','bg-blue-600'); btn.classList.replace('hover:bg-red-700','hover:bg-blue-700'); }
    listenForMarkers();
}

function onMapClick(e){
    if(isEditorMode){ currentLatLng=e.latlng; document.getElementById('pin-form').reset(); showModal('pin-modal'); }
}

function handlePinFormSubmit(e){
    e.preventDefault();
    if(!currentLatLng) return;
    const name=document.getElementById('pin-name').value;
    const desc=document.getElementById('pin-desc').value;
    firebase.database().ref('markers').push({ lat: currentLatLng.lat, lng: currentLatLng.lng, name, description: desc });
    hideModal('pin-modal');
}

function handleDeleteClick(e){
    if(e.target.classList.contains('delete-btn')){
        const id=e.target.dataset.id;
        confirmAction=()=>firebase.database().ref('markers/'+id).remove();
        showConfirm('Are you sure you want to delete this pin?');
    }
}

async function handleSearchSubmit(e){
    e.preventDefault();
    const query=document.getElementById('search-input').value;
    if(!query) return;
    try{
        const resp=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data=await resp.json();
        if(data.length>0){
            const [lat,lon]=[parseFloat(data[0].lat),parseFloat(data[0].lon)];
            map.flyTo([lat,lon],13);
            L.popup().setLatLng([lat,lon]).setContent(`<b>Search Result:</b><br>${escapeHTML(data[0].display_name)}`).openOn(map);
        } else showAlert('Location not found');
    } catch(e){ console.error(e); showAlert('Search failed'); }
}

// --- Init ---
function main(){
    initMap();
    listenForMarkers();
    document.getElementById('editor-mode-btn').addEventListener('click',toggleEditorMode);
    document.getElementById('password-form').addEventListener('submit',handlePasswordSubmit);
    document.getElementById('cancel-password-btn').addEventListener('click',()=>hideModal('password-modal'));
    document.getElementById('pin-form').addEventListener('submit',handlePinFormSubmit);
    document.getElementById('cancel-pin-btn').addEventListener('click',()=>hideModal('pin-modal'));
    document.getElementById('map').addEventListener('click',handleDeleteClick);
    document.getElementById('search-form').addEventListener('submit',handleSearchSubmit);
    document.getElementById('ok-alert-btn').addEventListener('click',()=>hideModal('alert-modal'));
    document.getElementById('cancel-confirm-btn').addEventListener('click',()=>{confirmAction=null; hideModal('confirm-modal');});
    document.getElementById('confirm-action-btn').addEventListener('click',()=>{if(typeof confirmAction==='function') confirmAction(); confirmAction=null; hideModal('confirm-modal');});
}

main();
</script>
</body>
</html>
